# docker-compose -f /application/docker-compose.yml --env-file /.env down && docker-compose -f /application/docker-compose.yml --env-file /.env up --detach && docker container logs application-rabbit-1 --follow
services:
  apache:
    image: httpd:2.4
    container_name: httpd
    ports:
      - '8181:80'
    volumes:
      - /application/httpd/htdocs:/usr/local/apache2/htdocs
    extra_hosts:
      - "host.docker.internal:host-gateway"
  httpdproxy:
    image: httpd:latest
    ports:
      - "80:80"
    volumes:
      - ./httpd-proxy/httpd.conf:/usr/local/apache2/conf/httpd.conf:ro
    extra_hosts:
      - "host.docker.internal:host-gateway"
  basic-server:
    build:
      context: ./
      no_cache: true
    restart: always
    container_name: kotlin-ktor-server
    ports:
      - ${BASIC_SERVER_PORT_MAP}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      - COLLECTOR_EXCHANGE=collector-exchange
      - COLLECTOR_QUEUE=collector-queue-${HOSTNAME}-a
      - WEBSERVER_EXCHANGE=webserver-exchange
      - WEBSERVER_QUEUE=webserver-queue-${HOSTNAME}-a
      - RABBIT_URL=host.docker.internal
      - PORT=8888
      - APP=webserver/build/libs/webserver.jar
      - AWSHOSTNAME=${HOSTNAME}
#  data-analyzer:
#    build:
#      context: ./
#      no_cache: true
#    restart: always
#    container_name: kotlin-ktor-analyzer
#    extra_hosts:
#      - "host.docker.internal:host-gateway"
#    ports:
#      - ${DATA_ANALYZER_PORT_MAP}
#    environment:
#      - WEBSERVER_EXCHANGE=webserver-exchange
#      - WEBSERVER_QUEUE=webserver-queue-${HOSTNAME}-b
#      - ANALYZER_EXCHANGE=analyzer-exchange
#      - ANALYZER_QUEUE=analyzer-queue-${HOSTNAME}-a
#      - RABBIT_URL=host.docker.internal
#      - PORT=8887
#      - APP=analyzer/build/libs/analyzer.jar
#      - AWSHOSTNAME=${HOSTNAME}
#  data-collector:
#    build:
#      context: ./
#      no_cache: true
#    restart: always
#    container_name: kotlin-ktor-collector
#    ports:
#      - ${DATA_COLLECTOR_PORT_MAP}
#    extra_hosts:
#      - "host.docker.internal:host-gateway"
#    environment:
#      - ANALYZER_EXCHANGE=analyzer-exchange
#      - ANALYZER_QUEUE=analyzer-queue-${HOSTNAME}-b
#      - COLLECTOR_EXCHANGE=collector-exchange
#      - COLLECTOR_QUEUE=collector-queue-${HOSTNAME}-b
#      - RABBIT_URL=host.docker.internal
#      - PORT=8886
#      - APP=collector/build/libs/collector.jar
#      - AWSHOSTNAME=${HOSTNAME}
  rabbit:
    network_mode: "host"
    image: rabbitmq:3.12-alpine
    restart: always
    environment:
      - RABBITMQ_NODENAME=${RABBITMQ_NODENAME}
      - CLUSTERED="${RABBIT_CLUSTERED}"
      - RABBITMQ_ERLANG_COOKIE=11111111111111111
      - RABBITMQ_CONFIG_FILE=/etc/rabbitmq/conf.d/90-rabbitmq.conf
    extra_hosts:
      - "${RABBIT_HOSTA}"
      - "${RABBIT_HOSTB}"
      - "${RABBIT_HOSTC}"
      - "${RABBIT_HOSTD}"
      - "${RABBIT_HOSTE}"
      - "host.docker.internal:host-gateway"
    command: >
      sh -c "rabbitmq-plugins enable --offline rabbitmq_management &&
             rabbitmq-plugins enable rabbitmq_consistent_hash_exchange &&
             rm -f /etc/rabbitmq/conf.d/20-management_agent.disable_metrics_collector.conf &&
             cp /plugins/rabbitmq_management-*/priv/www/cli/rabbitmqadmin /usr/local/bin/rabbitmqadmin &&
             chmod +x /usr/local/bin/rabbitmqadmin &&
             apk add --no-cache python3 &&
             rabbitmq-server"
    volumes:
      - /home/ec2-user/90-rabbitmq.conf:/etc/rabbitmq/conf.d/90-rabbitmq.conf

  solr1:
    image: solr:8.7.0
    network_mode: "host"
    restart: always
    container_name: solr1
    environment:
      - ZK_HOST=${SOLR_ZK_HOST}
      - SOLR_HOST=${IPADDRA}
      - SOLR_PORT=8981
    depends_on:
      - zooAws

  solr2:
    image: solr:8.7.0
    network_mode: "host"
    restart: always
    container_name: solr2
    environment:
      - ZK_HOST=${SOLR_ZK_HOST}
      - SOLR_HOST=${IPADDRB}
      - SOLR_PORT=8982
    depends_on:
      - zooAws

  solr3:
    image: solr:8.7.0
    network_mode: "host"
    restart: always
    container_name: solr3
    environment:
      - ZK_HOST=${SOLR_ZK_HOST}
      - SOLR_HOST=${IPADDRC}
      - SOLR_PORT=8983
    depends_on:
      - zooAws

  zooAws:
    image: zookeeper:3.6.2
    network_mode: "host"
    container_name: zoo1
    restart: always
    hostname: zoo1
    environment:
      ZOO_MY_ID: ${ZOO1_ID}
      ZOO_SERVERS: ${ZOO_SERVERS}
      ZOO_4LW_COMMANDS_WHITELIST: mntr, conf, ruok
      ZOO_CFG_EXTRA: "metricsProvider.className=org.apache.zookeeper.metrics.prometheus.PrometheusMetricsProvider metricsProvider.httpPort=7000 metricsProvider.exportJvmInfo=true"
#    networks:
#      - solr

#  zoo2:
#    image: zookeeper:3.6.2
#    container_name: zoo2
#    hostname: zoo2
#    ports:
#      - "${ZOO2_PORTS}"
#      - 7002:7000
#      - "${ZOO2_COMMANDS}"
#      - "${ZOOIPB}:22888-23888:2888-3888"
#    environment:
#      ZOO_MY_ID: ${ZOO2_ID}
#      ZOO_SERVERS: ${ZOO_SERVERS}
#      ZOO_4LW_COMMANDS_WHITELIST: mntr, conf, ruok
#      ZOO_CFG_EXTRA: "metricsProvider.className=org.apache.zookeeper.metrics.prometheus.PrometheusMetricsProvider metricsProvider.httpPort=7000 metricsProvider.exportJvmInfo=true"
##    networks:
##      - solr
#
#  zoo3:
#    image: zookeeper:3.6.2
#    container_name: zoo3
#    hostname: zoo3
#    ports:
#      - "${ZOO3_PORTS}"
#      - 7003:7000
#      - "${ZOO3_COMMANDS}"
#      - "${ZOOIPC}:32888-33888:2888-3888"
#    environment:
#      ZOO_MY_ID: ${ZOO3_ID}
#      ZOO_SERVERS: ${ZOO_SERVERS}
#      ZOO_4LW_COMMANDS_WHITELIST: mntr, conf, ruok
#      ZOO_CFG_EXTRA: "metricsProvider.className=org.apache.zookeeper.metrics.prometheus.PrometheusMetricsProvider metricsProvider.httpPort=7000 metricsProvider.exportJvmInfo=true"
#    networks:
#      - solr
#
#networks:
#  solr: